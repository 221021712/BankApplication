<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Accounts | Bank Portal</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

<!-- HEADER -->
<header>
    <div class="container header-container">
        <div class="logo">
            <i class="fas fa-university"></i>
            <span>Dekago Bank</span>
        </div>
        <nav>
            <ul>
                <li><a href="/dashboard">Dashboard</a></li>
                <li><a onclick="openModal('createModal')">Create Internal Account</a></li>
            </ul>
        </nav>
        <div class="auth-buttons">
            <button class="btn btn-outline" onclick="window.location.href='/'">Logout</button>
        </div>
    </div>
</header>

<!-- MAIN SECTION -->
<section class="container" style="padding: 60px 0; width: 90%; margin: auto;">
    <h1 style="color: #004080; text-align: center; margin-bottom: 40px;">My Accounts</h1>

    <!-- Accounts Grid -->
    <div id="accountsGrid" class="features-grid"></div>

    <!-- Recent Transactions -->
    <div class="section-title" style="margin-top: 80px;">
        <h2>Recent Transactions</h2>
        <p>Track your latest account activity.</p>
    </div>

    <div id="transactionsList" style="max-width:700px; margin:0 auto; text-align:center; color:gray;">
        <p>No transactions yet.</p>
    </div>
</section>

<!-- TRANSFER MODAL -->
<div id="transferModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Transfer Funds</h2>
            <button class="close-modal" onclick="closeModal('transferModal')">&times;</button>
        </div>
        <div class="modal-body">
            <form id="transferForm">
                <div class="form-group">
                    <label>From Account</label>
                    <input type="text" id="fromAccountDisplay" class="form-control" readonly>
                    <input type="hidden" id="fromAccount">
                </div>

                <div class="form-group">
                    <label>To Account</label>
                    <select id="toAccount" class="form-control"></select>
                </div>

                <div class="form-group">
                    <label>Amount</label>
                    <input type="number" id="transferAmount" placeholder="Enter amount" class="form-control" required>
                </div>

                <button type="submit" class="btn btn-primary">Transfer</button>
            </form>
        </div>
    </div>
</div>

<!-- CREATE ACCOUNT MODAL -->
<div id="createModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Create New Account</h2>
            <button class="close-modal" onclick="closeModal('createModal')">&times;</button>
        </div>
        <div class="modal-body">
            <form id="createAccountForm">
                <div class="form-group">
                    <label>Select Account Type</label>
                    <select id="accountType" class="form-control">
                        <option>üí∞ Savings Account</option>
                        <option>üè¢ Business Account</option>
                        <option>üí≥ Credit Account</option>
                        <option>üè¶ Fixed Deposit</option>
                        <option>üåç Forex Account</option>
                        <option>üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Family Account</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Initial Deposit</label>
                    <input type="number" id="initialDeposit" placeholder="Enter amount (can be 0)" class="form-control">
                </div>
                <button type="submit" class="btn btn-secondary">Create Account</button>
            </form>
        </div>
    </div>
</div>

<footer>
    <div class="copyright">¬© 2025 Bank Portal | All rights reserved.</div>
</footer>

<script src="https://kit.fontawesome.com/a2e0d6b8aa.js" crossorigin="anonymous"></script>

<!-- üî• Firebase Integration -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getDatabase, ref, get, push, set } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAljsKmPE-ydqESzPgXFBN2u5otm0WJCCQ",
        authDomain: "java-app-8ebd6.firebaseapp.com",
        databaseURL: "https://java-app-8ebd6-default-rtdb.firebaseio.com",
        projectId: "java-app-8ebd6",
        storageBucket: "java-app-8ebd6.appspot.com",
        messagingSenderId: "839009704629",
        appId: "1:839009704629:web:3a6c95efc17f7fca984f2e"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);
    let currentUserId = null;

    // ‚úÖ Load Accounts
    async function loadAccounts() {
        const grid = document.getElementById("accountsGrid");
        grid.innerHTML = "";

        const userRef = ref(db, "accounts/" + currentUserId);
        const snapshot = await get(userRef);

        if (snapshot.exists()) {
            const data = snapshot.val();

            // ‚úÖ Main Account
            const mainAccount = {
                type: data.accountType || "Main Account",
                balance: parseFloat(data.initialDeposit || 0),
                accountNumber: data.idNumber || "000000"
            };

            const mainCard = document.createElement("div");
            mainCard.classList.add("feature-card");
            mainCard.innerHTML = `
                <h3>${mainAccount.type}</h3>
                <p style="font-size:1.4rem; font-weight:bold;">R${mainAccount.balance.toFixed(2)}</p>
                <p>**** ${mainAccount.accountNumber.toString().slice(-4)}</p>
                <button class="btn btn-secondary" onclick="openTransfer('main', '${mainAccount.type}', '${mainAccount.accountNumber}')">Transfer</button>
            `;
            grid.appendChild(mainCard);

            // ‚úÖ Internal Accounts
            Object.keys(data).forEach((key) => {
                if (typeof data[key] === "object" && data[key].type && key !== "transactions") {
                    const acc = data[key];
                    const card = document.createElement("div");
                    card.classList.add("feature-card");
                    card.innerHTML = `
                        <h3>${acc.type}</h3>
                        <p style="font-size:1.4rem; font-weight:bold;">R${(acc.balance || 0).toFixed(2)}</p>
                        <p>**** ${acc.accountNumber || key.slice(-4)}</p>
                        <button class="btn btn-secondary" onclick="openTransfer('${key}', '${acc.type}', '${acc.accountNumber}')">Transfer</button>
                    `;
                    grid.appendChild(card);
                }
            });
        }

        // ‚úÖ Add ‚ÄúCreate New Account‚Äù Card
        const createCard = document.createElement("div");
        createCard.classList.add("feature-card");
        createCard.style.cssText = "border-top:4px solid var(--primary-light); background:var(--light); text-align:center;";
        createCard.innerHTML = `
            <h3>Create New Account</h3>
            <p>Open another account type.</p>
            <button class="btn btn-primary" onclick="openModal('createModal')">+ Create Internal Account</button>
        `;
        grid.appendChild(createCard);

        populateToDropdown();
        loadTransactions();
    }

    // ‚úÖ Populate "To Account" Dropdown
    async function populateToDropdown() {
        const toSel = document.getElementById("toAccount");
        toSel.innerHTML = "";

        const accountsRef = ref(db, "accounts/" + currentUserId);
        const snapshot = await get(accountsRef);

        if (snapshot.exists()) {
            const data = snapshot.val();

            toSel.innerHTML += `<option value="main">Main Account (**** ${data.idNumber?.slice(-4) || "0000"}) - R${parseFloat(data.initialDeposit || 0).toFixed(2)}</option>`;

            Object.keys(data).forEach((key) => {
                if (typeof data[key] === "object" && data[key].type && data[key].balance !== undefined) {
                    const acc = data[key];
                    toSel.innerHTML += `<option value="${key}">${acc.type} (**** ${acc.accountNumber || key.slice(-4)}) - R${(acc.balance || 0).toFixed(2)}</option>`;
                }
            });
        }
    }

    // ‚úÖ Transfer Logic
    window.openTransfer = (fromKey, type, number) => {
        openModal('transferModal');
        document.getElementById("fromAccount").value = fromKey;
        document.getElementById("fromAccountDisplay").value = `${type} (**** ${number.toString().slice(-4)})`;
        populateToDropdown();
    };

    document.getElementById("transferForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        const from = document.getElementById("fromAccount").value;
        const to = document.getElementById("toAccount").value;
        const amount = parseFloat(document.getElementById("transferAmount").value);

        if (!from || !to || from === to) return alert("Please select two different accounts.");
        if (isNaN(amount) || amount <= 0) return alert("Enter a valid amount.");

        const userRef = ref(db, "accounts/" + currentUserId);
        const userSnap = await get(userRef);
        if (!userSnap.exists()) return alert("User data not found.");

        const data = userSnap.val();
        let fromAcc, toAcc;

        if (from === "main") fromAcc = { balance: parseFloat(data.initialDeposit || 0), type: "Main Account" };
        else fromAcc = data[from];

        if (to === "main") toAcc = { balance: parseFloat(data.initialDeposit || 0), type: "Main Account" };
        else toAcc = data[to];

        if (fromAcc.balance < amount) return alert("Insufficient funds.");

        // Update balances
        if (from === "main") data.initialDeposit = fromAcc.balance - amount;
        else data[from].balance = fromAcc.balance - amount;

        if (to === "main") data.initialDeposit = toAcc.balance + amount;
        else data[to].balance = (toAcc.balance || 0) + amount;

        await set(userRef, data);

        // ‚úÖ Record Transaction in global node
        const txRef = ref(db, "transactions");
        const newTx = {
            userId: currentUserId,
            from: fromAcc.type,
            to: toAcc.type,
            amount,
            type: "transfer",
            date: new Date().toLocaleString()
        };
        await push(txRef, newTx);

        alert("‚úÖ Transfer successful!");
        closeModal("transferModal");
        loadAccounts();
    });

    // ‚úÖ Load Transactions (transfer only)
    async function loadTransactions() {
        const txList = document.getElementById("transactionsList");
        txList.innerHTML = "<p>Loading...</p>";

        const txRef = ref(db, "transactions");
        const txSnap = await get(txRef);

        if (!txSnap.exists()) {
            txList.innerHTML = "<p>No transactions yet.</p>";
            return;
        }

        // Filter only transfer transactions for this user
        const transactions = Object.values(txSnap.val())
            .filter(tx => tx.type === "transfer" && tx.userId === currentUserId)
            .reverse();

        if (transactions.length === 0) {
            txList.innerHTML = "<p>No transactions yet.</p>";
            return;
        }

        txList.innerHTML = `
            <table style="width:100%; border-collapse:collapse; color:#333;">
                <tr style="background:#004080; color:#fff;">
                    <th style="padding:8px;">From</th>
                    <th>To</th>
                    <th>Amount</th>
                    <th>Date</th>
                </tr>
                ${transactions.map(tx => `
                    <tr style="border-bottom:1px solid #ddd;">
                        <td>${tx.from}</td>
                        <td>${tx.to}</td>
                        <td>R${parseFloat(tx.amount).toFixed(2)}</td>
                        <td>${tx.date}</td>
                    </tr>
                `).join("")}
            </table>
        `;
    }

    // ‚úÖ Auth
    onAuthStateChanged(auth, (user) => {
        if (user) {
            currentUserId = user.uid;
            loadAccounts();
        } else {
            window.location.href = "/";
        }
    });

    // ‚úÖ Modals
    window.openModal = (id) => document.getElementById(id).style.display = "block";
    window.closeModal = (id) => document.getElementById(id).style.display = "none";
    window.onclick = (event) => {
        document.querySelectorAll(".modal").forEach(modal => {
            if (event.target === modal) modal.style.display = "none";
        });
    };
</script>
</body>
</html>
